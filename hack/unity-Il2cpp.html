<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>unity-I2cpp逆向 | jkcs 随记</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/jkcs-blog/assets/css/0.styles.ffa3548c.css" as="style"><link rel="preload" href="/jkcs-blog/assets/js/app.8e95ca7e.js" as="script"><link rel="preload" href="/jkcs-blog/assets/js/2.0881ac27.js" as="script"><link rel="preload" href="/jkcs-blog/assets/js/3.29b3410d.js" as="script"><link rel="prefetch" href="/jkcs-blog/assets/js/10.07f57d20.js"><link rel="prefetch" href="/jkcs-blog/assets/js/11.57e80c75.js"><link rel="prefetch" href="/jkcs-blog/assets/js/12.b730dee6.js"><link rel="prefetch" href="/jkcs-blog/assets/js/13.ee0a7bd1.js"><link rel="prefetch" href="/jkcs-blog/assets/js/14.ff217582.js"><link rel="prefetch" href="/jkcs-blog/assets/js/15.1df8ca7a.js"><link rel="prefetch" href="/jkcs-blog/assets/js/16.c644e5e9.js"><link rel="prefetch" href="/jkcs-blog/assets/js/4.746c9dba.js"><link rel="prefetch" href="/jkcs-blog/assets/js/5.b73fdea4.js"><link rel="prefetch" href="/jkcs-blog/assets/js/6.ff73ea7a.js"><link rel="prefetch" href="/jkcs-blog/assets/js/7.b48efae8.js"><link rel="prefetch" href="/jkcs-blog/assets/js/8.14b620b8.js"><link rel="prefetch" href="/jkcs-blog/assets/js/9.5ebe70f8.js">
    <link rel="stylesheet" href="/jkcs-blog/assets/css/0.styles.ffa3548c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/jkcs-blog/" class="home-link router-link-active"><!----> <span class="site-name">jkcs 随记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jkcs-blog/essay/code-review.html" class="sidebar-link">议code review</a></li><li><a href="/jkcs-blog/essay/reflections-on-reverse.html" class="sidebar-link">对逆向工作的一些想法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>逆向与破解</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jkcs-blog/hack/frida.html" class="sidebar-link">frida介绍和基本使用</a></li><li><a href="/jkcs-blog/hack/unity-Il2cpp.html" aria-current="page" class="active sidebar-link">unity-I2cpp逆向</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_1-获取libil2cpp-so文件" class="sidebar-link">1. 获取libil2cpp.so文件</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_2-获取metadata文件" class="sidebar-link">2. 获取metadata文件</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_3-使用il2cppdumper还原dll文件" class="sidebar-link">3. 使用Il2cppdumper还原DLL文件</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_4-使用dnspy反编译dll文件" class="sidebar-link">4. 使用dnSpy反编译DLL文件</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_5-使用ida分析libil2cpp-so" class="sidebar-link">5. 使用IDA分析libil2cpp.so</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_6-分析游戏内是否有lua脚本" class="sidebar-link">6. 分析游戏内是否有lua脚本</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_7-dump出lua脚本" class="sidebar-link">7. dump出lua脚本</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_8-使用frida-hook-lua脚本" class="sidebar-link">8. 使用frida hook lua脚本</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/hack/unity-Il2cpp.html#_9-其他" class="sidebar-link">9. 其他</a></li></ul></li><li><a href="/jkcs-blog/hack/android-inject.html" class="sidebar-link">Android 注入的三种注入方式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>js相关内容</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jkcs-blog/js/utils.html" class="sidebar-link">一些好用的js代码</a></li><li><a href="/jkcs-blog/js/react-to-print.html" class="sidebar-link">打印分页处理（react-to-print）</a></li><li><a href="/jkcs-blog/js/amis-analyze.html" class="sidebar-link">amis 打包大分析</a></li></ul></section></li><li><a href="/jkcs-blog/about.html" class="sidebar-link">关于此博客</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="unity-i2cpp逆向"><a href="#unity-i2cpp逆向" class="header-anchor">#</a> unity-I2cpp逆向</h1> <p>对于I2cpp的逆向，主要步骤如下：</p> <ol><li>获取libil2cpp.so文件（未加密的可以从apk中提取，加密的可以从内存中dump）</li> <li>获取metadata文件（从apk中提取，部分apk有加密，代码中可以找到解密方法）</li> <li>使用<a href="https://github.com/Perfare/Il2CppDumper" target="_blank" rel="noopener noreferrer">Il2cppdumper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>还原DLL文件、dump.cs、方法名和常量等等</li> <li>使用<a href="https://github.com/dnSpy/dnSpy" target="_blank" rel="noopener noreferrer">dnSpy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>反编译DLL文件，分析关键类和方法（基本上这里都只能看到方法名和类定义）</li> <li>使用IDA分析libil2cpp.so，分析关键函数和逻辑，借助上上一步导入到IDA中，详见<a href="https://github.com/Perfare/Il2CppDumper/blob/master/README.zh-CN.md#ida_with_structpy" target="_blank" rel="noopener noreferrer">ida_with_structpy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>分析游戏内是否有lua脚本，如果有，可以使用frida dump lua脚本，分析关键逻辑</li> <li>dump出lua脚本，如果有加密，可以使用<code>unluac.jar</code>尝试解密</li> <li>使用frida hook lua脚本，修改游戏逻辑，或者你想做的任何事情</li></ol> <h2 id="_1-获取libil2cpp-so文件"><a href="#_1-获取libil2cpp-so文件" class="header-anchor">#</a> 1. 获取libil2cpp.so文件</h2> <p>apk文件本身就是一个zip文件，可以直接解压，然后在<code>lib\armeabi-v7a</code>或者<code>lib\arm64-v8a</code>目录下找到<code>libil2cpp.so</code>文件。如果更改成<code>.zip</code>文件后无法解压，那么通过010Editor打开，看文件头的部分是否是<code>PK</code>如果不是则改成<code>PK</code>。</p> <p>如果是加密的，可以先尝试在内存中dump，若果还是加密的，则需要找到解密方法，这个暂时不做讨论。
如果遇到可以试试<a href="https://github.com/Perfare/Zygisk-Il2CppDumper/blob/master/README.zh-CN.md" target="_blank" rel="noopener noreferrer">Zygisk-Il2CppDumper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>工具</p> <p>游戏厂商为了防止反编译，会对编译出来的apk包修改一些指定标识位，导致无法正常解压或反编译这个时候拿正常的apk对应把标识位进行修改即可。最常见的标识位修改是<code>zip</code>标识头。</p> <h2 id="_2-获取metadata文件"><a href="#_2-获取metadata文件" class="header-anchor">#</a> 2. 获取metadata文件</h2> <p>metadata文件是一个二进制文件，在解压后的apk目录下，可以找到<code>assets\bin\Data\Managed\Metadata</code>目录，里面有一个<code>global-metadata.dat</code>文件，这个就是metadata文件。
如果没有或者文件是加密的可以使用<a href="https://github.com/IIIImmmyyy/frida-il2cppDumper" target="_blank" rel="noopener noreferrer">frida-il2cppDumper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>从内存中dump出来。</p> <h2 id="_3-使用il2cppdumper还原dll文件"><a href="#_3-使用il2cppdumper还原dll文件" class="header-anchor">#</a> 3. 使用Il2cppdumper还原DLL文件</h2> <p>下载<a href="https://github.com/Perfare/Il2CppDumper/releases" target="_blank" rel="noopener noreferrer">Il2CppDumper-win<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，双击打开，先选择<code>libil2cpp.so</code>、再选择<code>global-metadata.dat</code>文件，等待完成。
完成后会生成<code>dump.cs</code>、<code>DummyDll</code>、<code>script.json</code>、<code>stringliteral.json</code>、<code>il2cpp.h</code>等文件。
DummyDll内是还原出来的DLL文件，可以使用dnSpy打开，但是只能看到方法名和类定义，不能看到方法体。
在<code>IDA</code>中可以使用<code>ida_with_struct_py3.py</code>脚本导入，可以让<code>IDA</code>的伪代码有结构定义。</p> <h2 id="_4-使用dnspy反编译dll文件"><a href="#_4-使用dnspy反编译dll文件" class="header-anchor">#</a> 4. 使用dnSpy反编译DLL文件</h2> <p>下载<a href="https://github.com/dnSpy/dnSpy/releases" target="_blank" rel="noopener noreferrer">dnSpy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
使用dnSpy打开<code>DummyDll</code>文件夹，可以看到方法名和类定义，一般游戏内的自定义空间都会在<code>Assembly-CSharp.dll</code>中，可以关注这个DLL文件。</p> <h2 id="_5-使用ida分析libil2cpp-so"><a href="#_5-使用ida分析libil2cpp-so" class="header-anchor">#</a> 5. 使用IDA分析libil2cpp.so</h2> <ul><li>将<code>libil2cpp.so</code>文件拖入IDA中，等待分析完成（左下角地址码不跳）。</li> <li>将上面步骤生成的定义加载到IDA中，<code>File-&gt;Script file</code>，选择<code>ida_with_struct_py3.py</code>脚本。
<img src="/jkcs-blog/assets/img/ida_script_file.6d2dab25.png" alt="ida_script_file.png"> <img src="data:image/png;base64,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" alt="ida_script_file.png"></li> <li>之后依次选择<code>script.json</code>、<code>il2cpp.h</code>文件，等待加载完成。</li> <li>可以看到IDA中的伪代码有结构定义了。</li> <li>打开<code>dump.cs</code>根据<code>Offset: 0x000</code>地址在ida中找到对应的函数，分析逻辑。</li> <li>补充一些IDA常用快捷键，
<ul><li>x 为搜索引用，</li> <li>g 跳转到地址，</li> <li>n 重命名，</li> <li>/ 添加备注，</li> <li>tab 切换视图，</li> <li>space 切换hex和汇编视图。</li></ul></li></ul> <h2 id="_6-分析游戏内是否有lua脚本"><a href="#_6-分析游戏内是否有lua脚本" class="header-anchor">#</a> 6. 分析游戏内是否有lua脚本</h2> <p>首先我们进入解压的apk内，在lib文件夹下，寻找关键词<code>lua</code>，例如<code>libluajit.so</code>、<code>libtolua.so</code>、<code>libxlua.so</code>如果看到这些so则大致可以判断游戏内存在<code>lua</code>脚本。
游戏厂商为了游戏能实现热更新效果，不用每次更新版本都需要重新安装apk，都会将一部分逻辑放在lua脚本。
找到so后，我们需要将so拖到IDA中进行分析，我们直接看导出表。
<img src="/jkcs-blog/assets/img/ida_export.7f66c5bd.png" alt="ida_export.png"> <img src="/jkcs-blog/assets/img/ida_lua_so_export.c96499ef.png" alt="ida_lua_so_export.png">
可以看到有<code>luaL_loadbuffer</code>、<code>luaL_loadbufferx</code>、<code>luaL_loadfile</code>、<code>luaL_loadstring</code>等函数，这些函数都是lua脚本加载函数，这些函数都非常关键下面会提到。</p> <h2 id="_7-dump出lua脚本"><a href="#_7-dump出lua脚本" class="header-anchor">#</a> 7. dump出lua脚本</h2> <p>分析该so文件，根据分析所有的lua文件加载都会经过<code>luaL_loadbufferx</code>函数，所以我们只需要hook这个函数，就可以dump出所有的lua脚本。
这里我们自己编写脚本来实现hook，大体步骤如下：</p> <ol><li>在游戏打开时立即hook</li> <li>在导出表内找到<code>luaL_loadbufferx</code>函数的地址。</li> <li>通过观察<code>luaL_loadbufferx</code>函数的参数，arg 0是lua env, arg 1是脚本content; arg 2是脚本size; arg 3脚本名称name</li> <li>hook该函数，在<code>onEnter</code>时发送加载的lua文件到<code>py</code>。</li> <li>将接收到的lua脚本，写入到指定目录内。</li></ol> <p>编写该脚本如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># dump_lua.py</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> frida
<span class="token keyword">import</span> sys

jscode <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
    console.log('start hook')
    var addr = Module.findExportByName('libtolua.so', 'luaL_loadbufferx');
    while(addr == null) {
        addr = Module.findExportByName('libtolua.so', 'luaL_loadbufferx');
    }

    console.log('addr', addr)
    Interceptor.attach(addr, {
        onEnter: function(args) {
           var name = Memory.readUtf8String(args[3]);
           var obj = {};
           obj.size = args[2].toInt32()
           obj.name = name;
           obj.content = Memory.readByteArray(args[1], obj.size)
           send(String(name), obj.content)
       }
    })
&quot;&quot;&quot;</span>

<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'writh'</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
    folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>folder<span class="token punctuation">)</span>
    <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">on_message</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> message<span class="token punctuation">[</span><span class="token string">'payload'</span><span class="token punctuation">]</span>
    content <span class="token operator">=</span> data
    write<span class="token punctuation">(</span><span class="token string">&quot;lua_script/&quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">'.lua'</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    device <span class="token operator">=</span> frida<span class="token punctuation">.</span>get_remote_device<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pid <span class="token operator">=</span> device<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;your game package name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    session <span class="token operator">=</span> device<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
    device<span class="token punctuation">.</span>resume<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    script <span class="token operator">=</span> session<span class="token punctuation">.</span>create_script<span class="token punctuation">(</span>jscode<span class="token punctuation">)</span>

    script<span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> on_message<span class="token punctuation">)</span>
    script<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>运行该脚本</p> <div class="language-shell extra-class"><pre class="language-shell"><code>python dump_lua.py
</code></pre></div><p>打开游戏，可以看到lua脚本被dump到<code>lua_script</code>文件夹内，多点击游戏内的各个环节，尽量将游戏内的<code>lua</code>脚本都下载下来。</p> <h2 id="_8-使用frida-hook-lua脚本"><a href="#_8-使用frida-hook-lua脚本" class="header-anchor">#</a> 8. 使用frida hook lua脚本</h2> <p>在上面我们dump出了lua脚本，但是我们还需要分析lua脚本的逻辑，比如我们分析出来一个lua脚本是我们需要替换更改的，我们可以使用hook将此脚本替换为我们更改过的lua脚本。
实现思路是：hook<code>luaL_loadbufferx</code>函数，当加载脚本时如果脚本在本地文件夹内存在，则读取本地文件夹内的脚本，否则加载原始脚本。
实现代码如下:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// lua_dump.js</span>
<span class="token keyword">function</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token parameter">filePath<span class="token punctuation">,</span> data<span class="token punctuation">,</span> dataLen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dumpfile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dumpfile<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>dataLen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dumpfile<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'unity_dump_lua'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string-property property">'filePath'</span><span class="token operator">:</span> filePath <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ptr_access <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">,</span> <span class="token string">'access'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> func_access <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>ptr_access<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ptr_filepath <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">allocUtf8String</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">func_access</span><span class="token punctuation">(</span>ptr_filepath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token parameter">Path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ptr_mkdir <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'mkdir'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> func_mkdir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>ptr_mkdir<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ptr_filepath <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">allocUtf8String</span><span class="token punctuation">(</span>Path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">func_mkdir</span><span class="token punctuation">(</span>ptr_filepath<span class="token punctuation">,</span> <span class="token number">755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">folder_mkdirs</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> app_path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p_list <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> pp <span class="token operator">=</span> app_path<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> p_list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pp <span class="token operator">=</span> pp <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> p_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mkdir</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ptr_open <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> open <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>ptr_open<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ptr_read <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">,</span> <span class="token string">'read'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> read <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>ptr_read<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ptr_close <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">,</span> <span class="token string">'close'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> close <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>ptr_close<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>Memory<span class="token punctuation">.</span><span class="token function">allocUtf8String</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token function">get_file_size</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> data<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Unable to read DLL [!] '</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> data<span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> size <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">get_file_size</span><span class="token punctuation">(</span><span class="token parameter">fd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> statBuff <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fstatSymbol <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">,</span> <span class="token string">'fstat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fstat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>fstatSymbol<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token string">'pointer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> statBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] fstat --&gt; failed [!]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Memory<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span>statBuff<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">dump_lua</span><span class="token punctuation">(</span><span class="token parameter">package_name<span class="token punctuation">,</span> addr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app_path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/data/data/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>package_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/luadump/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// args[1] content; args[2] size; args[3] name</span>
      <span class="token keyword">const</span> name <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">50</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> path <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>app_path <span class="token operator">+</span> path<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">folder_mkdirs</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> app_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>app_path <span class="token operator">+</span> name<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">'chunk'</span> <span class="token operator">&amp;&amp;</span> name <span class="token operator">!==</span> <span class="token string">'Init'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span>app_path <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'open '</span> <span class="token operator">+</span> app_path <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">' failed !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">writeByteArray</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'load lua file :'</span> <span class="token operator">+</span> app_path <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">dump</span><span class="token punctuation">(</span>app_path <span class="token operator">+</span> name<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dump :'</span> <span class="token operator">+</span> app_path <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> addr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libtolua.so'</span><span class="token punctuation">,</span> <span class="token string">'luaL_loadbufferx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  addr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libtolua.so'</span><span class="token punctuation">,</span> <span class="token string">'luaL_loadbufferx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start hook'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'addr'</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dump_lua</span><span class="token punctuation">(</span><span class="token string">'your package name'</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们将<code>/data/data/${package_name}/luadump/</code>作为我们的脚本存放目录，在第一次运行的时候我们把加载的lua脚本dump到这个目录下，然后我们可以修改这个目录下的lua脚本，再次执行脚本，这时候我们的lua脚本就会被替换为我们修改过的lua脚本。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 执行脚本</span>
frida <span class="token parameter variable">-U</span> <span class="token parameter variable">-f</span> your package name <span class="token parameter variable">-l</span> lua_dump.js <span class="token parameter variable">--pause</span>
</code></pre></div><h2 id="_9-其他"><a href="#_9-其他" class="header-anchor">#</a> 9. 其他</h2> <ul><li>使用<a href="https://github.com/skylot/jadx/releases" target="_blank" rel="noopener noreferrer">jadx-gui<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>反编译apk文件，查看游戏逻辑</li> <li>使用<a href="https://github.com/SeriousCache/UABE/releases" target="_blank" rel="noopener noreferrer">AssetBundleExtractor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>分析unity游戏的静态资源文件，或者更改。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/18/2023, 9:32:20 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/jkcs-blog/hack/frida.html" class="prev">
        frida介绍和基本使用
      </a></span> <span class="next"><a href="/jkcs-blog/hack/android-inject.html">
        Android 注入的三种注入方式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/jkcs-blog/assets/js/app.8e95ca7e.js" defer></script><script src="/jkcs-blog/assets/js/2.0881ac27.js" defer></script><script src="/jkcs-blog/assets/js/3.29b3410d.js" defer></script>
  </body>
</html>
