<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>amis 打包大分析 | jkcs 随记</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/jkcs-blog/assets/css/0.styles.ffa3548c.css" as="style"><link rel="preload" href="/jkcs-blog/assets/js/app.e2723f46.js" as="script"><link rel="preload" href="/jkcs-blog/assets/js/2.2179b996.js" as="script"><link rel="preload" href="/jkcs-blog/assets/js/8.66e4f8f1.js" as="script"><link rel="prefetch" href="/jkcs-blog/assets/js/10.b80360d2.js"><link rel="prefetch" href="/jkcs-blog/assets/js/11.99a2baae.js"><link rel="prefetch" href="/jkcs-blog/assets/js/12.f0631d77.js"><link rel="prefetch" href="/jkcs-blog/assets/js/13.1cfc421f.js"><link rel="prefetch" href="/jkcs-blog/assets/js/14.6ec5b673.js"><link rel="prefetch" href="/jkcs-blog/assets/js/15.a0d31195.js"><link rel="prefetch" href="/jkcs-blog/assets/js/16.347efdf0.js"><link rel="prefetch" href="/jkcs-blog/assets/js/17.ab473518.js"><link rel="prefetch" href="/jkcs-blog/assets/js/3.27e68269.js"><link rel="prefetch" href="/jkcs-blog/assets/js/4.7d556b3f.js"><link rel="prefetch" href="/jkcs-blog/assets/js/5.619a0e91.js"><link rel="prefetch" href="/jkcs-blog/assets/js/6.a6db8efb.js"><link rel="prefetch" href="/jkcs-blog/assets/js/7.7cb31302.js"><link rel="prefetch" href="/jkcs-blog/assets/js/9.79ed1b22.js">
    <link rel="stylesheet" href="/jkcs-blog/assets/css/0.styles.ffa3548c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/jkcs-blog/" class="home-link router-link-active"><!----> <span class="site-name">jkcs 随记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jkcs-blog/essay/code-review.html" class="sidebar-link">议code review</a></li><li><a href="/jkcs-blog/essay/reflections-on-reverse.html" class="sidebar-link">对逆向工作的一些想法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>逆向与破解</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jkcs-blog/hack/frida.html" class="sidebar-link">frida介绍和基本使用</a></li><li><a href="/jkcs-blog/hack/unity-Il2cpp.html" class="sidebar-link">unity-I2cpp逆向</a></li><li><a href="/jkcs-blog/hack/android-inject.html" class="sidebar-link">Android 注入的三种注入方式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>js相关内容</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jkcs-blog/js/utils.html" class="sidebar-link">一些好用的js代码</a></li><li><a href="/jkcs-blog/js/react-to-print.html" class="sidebar-link">打印分页处理（react-to-print）</a></li><li><a href="/jkcs-blog/js/amis-analyze.html" aria-current="page" class="active sidebar-link">amis 打包大分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jkcs-blog/js/amis-analyze.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/js/amis-analyze.html#_1-打包体积过大" class="sidebar-link">1. 打包体积过大</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/js/amis-analyze.html#_2-打包时间过长-热更新慢" class="sidebar-link">2. 打包时间过长&amp;热更新慢</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/js/amis-analyze.html#_3-amis源码的建议" class="sidebar-link">3. amis源码的建议</a></li><li class="sidebar-sub-header"><a href="/jkcs-blog/js/amis-analyze.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/jkcs-blog/js/yarn-jsdom-node-version-error.html" class="sidebar-link">谈yarn和node版本</a></li></ul></section></li><li><a href="/jkcs-blog/about.html" class="sidebar-link">关于此博客</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="amis-打包大分析"><a href="#amis-打包大分析" class="header-anchor">#</a> amis 打包大分析</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>amis 是一个前端页面生成器，通过配置JSON的方式生成页面。当我们引入amis在实际项目中使用时，发现了一些问题。</p> <h2 id="_1-打包体积过大"><a href="#_1-打包体积过大" class="header-anchor">#</a> 1. 打包体积过大</h2> <p>经过<code>ANALYZE=1</code>分析，发现amis打包体积过大，就光<code>monaco-editor</code>就有6M（gzip后2.54m)。
<img src="/jkcs-blog/assets/img/amis-analyze.5a3dd3a7.png" alt="amis-analyze.png"></p> <h3 id="_1-1-项目分析"><a href="#_1-1-项目分析" class="header-anchor">#</a> 1.1 项目分析</h3> <p>项目内用到Amis的地方并不多，都是一些基础的增删改查页面，开发人员用amis配置写比较快。引入低代码的缘由是想提高开发效率，后面我们在实际跑了几个需求后，
得到的结论是：<strong>amis并没有显著的提高开发效率，反而增加了打包体积和时间，增加了学习成本，增加了维护成本</strong>。</p> <p>由于项目中还有很多其他页面，我们并不能将amis页面的项目单独独立，因为某些组件是其它页面中的一个子tab或者依赖项。
项目中我们使用到最多的就是amis的crud，form这些，我们可以尝试将一些没用到的组件去掉。</p> <h3 id="_1-2-amis源码分析"><a href="#_1-2-amis源码分析" class="header-anchor">#</a> 1.2 amis源码分析</h3> <p>amis功能是被划分成多个子包实现，分别是amis-core、amis-ui、amis-editor等等。</p> <p>官方建议的引入方式是：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'amis'</span><span class="token punctuation">;</span>
</code></pre></div><p>这样的引入会有个问题，我们看<code>packages/amis/src/index.tsx</code>的源码，
<img src="/jkcs-blog/assets/img/amis-index-tsx.3faf0a2a.png" alt="amis-index-tsx.png">
它会默认将所有的组件都注册上，组件从<code>amis-ui</code>中获取，所以我们引入<code>amis</code>就会将<code>amis-ui</code>中的所有组件都打包进来。</p> <h3 id="_1-3-它为什么要这样设计"><a href="#_1-3-它为什么要这样设计" class="header-anchor">#</a> 1.3 它为什么要这样设计</h3> <p>amis的初衷就是使用JSON配置的方式生成页面，所以它的组件是动态的。
就是说没有JSON的情况下，它不知道需要用到哪些组件，所以它只能将所有组件都准备好，将所有组件都先组件注册上。</p> <p>那么其实像amis这种框架，更适合与单独的项目，不适合与其它大型项目混合使用。</p> <h2 id="_2-打包时间过长-热更新慢"><a href="#_2-打包时间过长-热更新慢" class="header-anchor">#</a> 2. 打包时间过长&amp;热更新慢</h2> <p>分析完amis的源码，我们试着找一些解决方案。</p> <h3 id="_2-1-按需引入"><a href="#_2-1-按需引入" class="header-anchor">#</a> 2.1 按需引入</h3> <p>按需引入基本不可能实现，原因上面也说了，如果你的JSON是后台接口返回的，实际内容打包的时候不知道，那么哪些组件需要引入这个在打包过程中是不确定的。</p> <p>tree-shaking也是一样的道理，它也是需要在编译阶段(AST中分析)知道哪些组件需要引入，才可以知道那些组件未使用到能剔除。</p> <h3 id="_2-2-手动剔除"><a href="#_2-2-手动剔除" class="header-anchor">#</a> 2.2 手动剔除</h3> <p>简单分析了下amis-ui这个库，我发现它最大的体积并不是它本身而是<code>monaco-editor</code>和<code>froala-editor</code>。一个是<code>Editor</code>组件引入、一个是<code>RichText</code>组件引入。
我们可以手动剔除这两个依赖库，因为我知道我们项目中永远不会用到这两个组件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// 为防止将某些 import 的包(package)打包到 bundle 中，而是在运行时(runtime)再去从外部获取这些扩展依赖(external dependencies)。</span>
  <span class="token literal-property property">externals</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'monaco-editor'</span><span class="token operator">:</span> <span class="token string">'monaco-editor'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'froala-editor'</span><span class="token operator">:</span> <span class="token string">'froala-editor'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用这个方法操作下来，虽然有效果，但并未达到预期的效果，打包体积还是大，时间还是长。</p> <h3 id="_2-3-使用插件剔除"><a href="#_2-3-使用插件剔除" class="header-anchor">#</a> 2.3 使用插件剔除</h3> <p>大概思路是编写一个webpack插件，将<code>amis-ui</code>中的<code>Editor</code>引入都剔除掉，这样就不会打包进来了。</p> <p>可是我最终都没有实现这个插件，因为我发现我编写的插件都是有bug的会导致打包失败，而且我也没有太多时间花在这个上面。</p> <h3 id="_2-4-最终解决方案"><a href="#_2-4-最终解决方案" class="header-anchor">#</a> 2.4 最终解决方案</h3> <p>最后的解决方案是：将amis的页面全部剔除掉，能迁移的迁移到另一个纯amis项目，不能迁移的使用传统React重写。</p> <h2 id="_3-amis源码的建议"><a href="#_3-amis源码的建议" class="header-anchor">#</a> 3. amis源码的建议</h2> <p>更多的是对于打包体积过大的问题</p> <h3 id="声明式引入"><a href="#声明式引入" class="header-anchor">#</a> 声明式引入</h3> <p>我觉得amis可以提供声明式引入和全量引入两种方式。一种是把用到的组件让开发自行的去引入，这样虽然开发的成本会增加，
但是开发者可以对自己的项目进行优化，比如某些场景下完全可以判定<code>Editor</code>组件不会用到，那么就可以不声明引入。</p> <h3 id="插件化"><a href="#插件化" class="header-anchor">#</a> 插件化</h3> <p>amis的组件都是放在amis-ui中的，导致amis-ui的体积过大，并且如果想自己发布一个自己的组件，也需要将组件放在amis-ui中。
为什么不放在项目中，使用amis提供的自定义组件实践？那如果我有多个项目需要同时用到呢？甚至我觉得这个是很好的组件想分享给开源社区呢？</p> <p>插件化可以很好的解决这类问题，现在的框架都会提供插件化的方案，比如vue、react、webpack等等。这样能很好的增加扩展和解耦。</p> <p>amis完全可以将CRUD相关的组件作为基础组件放到基础组件库中，将<code>Editor</code>组件，当做一个插件，放到插件库中。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>amis是一个很好的低代码框架，但是它的设计初衷是为了单独的项目，不适合与其它项目混合使用。
如果在现有项目中使用，会显著增加打包体积和时间，最好的方式是将amis单独拆分出来，作为一个独立的项目。
如果amis想支持在现有项目中直接引入，需要其提供声明式引入和插件化的解决方案，否则不建议。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/23/2023, 3:13:07 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/jkcs-blog/js/react-to-print.html" class="prev">
        打印分页处理（react-to-print）
      </a></span> <span class="next"><a href="/jkcs-blog/js/yarn-jsdom-node-version-error.html">
        谈yarn和node版本
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/jkcs-blog/assets/js/app.e2723f46.js" defer></script><script src="/jkcs-blog/assets/js/2.2179b996.js" defer></script><script src="/jkcs-blog/assets/js/8.66e4f8f1.js" defer></script>
  </body>
</html>
